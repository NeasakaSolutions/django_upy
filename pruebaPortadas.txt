<script setup>
import Header from '@/components/Header.vue';
import Fondo from '@/components/Fondo.vue';
import Fotter from '@/components/Fotter.vue';
import { onMounted, ref } from 'vue';
import axios from 'axios';
import { Fancybox } from '@fancyapps/ui';
import "@fancyapps/ui/dist/fancybox.css";
import { useAuthStore } from '@/stores/authStore';

// Validaciones de superusuario para el menu lateral
let store = useAuthStore();

// Estado de la aplicación
const portadas = ref([]);
const modal_titulo = ref('');
const seccion = ref('');
const portada_id = ref(0);
const boton = ref('block');
const preloader = ref('none');

// URL base de tu API de Django. Debes configurar esto en tu entorno.
const API_URL = import.meta.env.VITE_API_URL;

// Lógica de carga de datos
const cargarPortadas = async () => {
    try {
        const respuesta = await axios.get(`${API_URL}portadas`);
        portadas.value = respuesta.data.data;
    } catch (error) {
        console.error('Error al cargar las portadas:', error);
        alert('Ocurrió un error al cargar las portadas.');
    }
};

// Cargar los datos al montar el componente
onMounted(() => {
    cargarPortadas();
});

// Lógica para el modal de Editar
const editar = (modelo) => {
    modal_titulo.value = 'Editar';
    portada_id.value = modelo.id;
    seccion.value = modelo.seccion;
};

// Enviar el formulario al API (solo para edición)
const enviar = async () => {
    boton.value = "none";
    preloader.value = "block";

    const formData = new FormData();
    formData.append('id', portada_id.value);
    formData.append('seccion', seccion.value);
    
    const file_foto = document.querySelector("#file_foto").files[0];
    if (file_foto) {
        formData.append('foto', file_foto);
    }
    
    try {
        await axios.post(`${API_URL}portadas/editar/foto`, formData);
        alert("Se modificó el registro exitosamente");
        // Llama a la nueva función para actualizar la lista de portadas
        await cargarPortadas();
        // Cierra el modal, ya que la página no se recargará
        window.location.href = '#close';
    } catch (err) {
        alert("Ocurrió un error inesperado: " + err);
    } finally {
        // Restablece el estado de los botones y el preloader
        boton.value = 'block';
        preloader.value = 'none';
    }
};

// Eliminar un registro
const eliminar = async (id) => {
    if (window.confirm("¿Eliminar registro?")) {
        // Tu API no tiene un endpoint DELETE.
        alert("La funcionalidad de eliminación no está implementada en tu API de Django.");
    }
};
</script>

<template>
    <Header></Header>
    <Fondo></Fondo>
    <div class="container my-5 d-flex flex-wrap gap-4">
        <div class="contenedor_blog_articulos flex-grow-1">
            <h5 class="titulos my-3">Panel</h5>
            <div class="row">
                <div class="col-12 d-flex gap-2 mb-4">
                    <a href="#" class="btn btn-outline-warning">Portadas</a>
                    <a href="#" class="btn btn-outline-warning">Videos</a>
                </div>
                <hr />
                
                <div class="col-12">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover align-middle text-center">
                            <thead class="table-warning">
                                <tr>
                                    <th>ID</th>
                                    <th>Sección</th>
                                    <th>Foto</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(portada, index) in portadas" :key="index">
                                    <td>{{ portada.id }}</td>
                                    <td>{{ portada.seccion }}</td>
                                    <td class="text-center">
                                        <a :href="portada.foto" class="lightbox d-block" data-fancybox="portada-gallery">
                                            <img :src="portada.foto" :alt="portada.seccion" style="width: 100px;">
                                        </a>
                                    </td>
                                    <td class="text-center">
                                        <a href="#modal" title="Editar" @click="editar(portada)" class="text-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        &nbsp;&nbsp;
                                        <a href="#" @click.prevent="eliminar(portada.id)" title="Eliminar" class="text-danger">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

       <div class="contenedor_blog_menu">
        <ul class="mini_menu_config">
            <li class="logo">
                <router-link to="/" title="Home" class="navbar-brand">
                    <img alt="Logotipo" src="/img/core-img/favicon.ico" class="logo_img" />
                </router-link>
            </li>
            <li v-if="store.authId == null">
                <router-link :to="{ name: 'login' }">Iniciar sesión</router-link>
            </li>
            <li v-else>
                <router-link :to="{ name: 'panel' }">Panel</router-link>
            </li>
            <li><router-link :to="{ name: 'blogs' }">Inicio</router-link></li>
            <li><router-link :to="{ name: 'BlogsGeneral' }">Blogs</router-link></li>
            <li><router-link :to="{ name: 'contacto' }">Contacto</router-link></li>
        </ul>
    </div>
    </div>

    <div class="modalmask" id="modal">
        <div class="modalbox rotate">
            <a href="#close" title="Cerrar" class="close">X</a>
            <h2>{{ modal_titulo }}</h2>
            <form @submit.prevent="enviar()">
                <div class="form-panel">
                    <div class="row container">
                        <div class="col-12 col-lg-12">
                            <input type="text" v-model="seccion" placeholder="Sección" class="form-control" required />
                        </div>
                        <div class="col-12 col-lg-12">
                            <label for="file_foto" class="form-label fw-bold">Subir foto:</label>
                            <input type="file" id="file_foto" class="form-control" />
                        </div>
                        <div class="col-12 text-center" :style="'display:' + boton">
                            <button class="btn btn-outline-warning" type="submit" title="Enviar">Enviar</button>
                        </div>
                        <div class="col-12 text-center" :style="'display:' + preloader">
                            <img src="/img/img/load.gif" alt="Cargando..." />
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <Fotter></Fotter>
</template>

<style scoped>
/* (Sección de estilos CSS sin cambios) */
/*--------------------------------------------------------------------------------- */
.modalmask {
    position: fixed;
    font-family: Arial, sans-serif;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 99999;
    opacity: 0;
    -webkit-transition: opacity 400ms ease-in;
    -moz-transition: opacity 400ms ease-in;
    transition: opacity 400ms ease-in;
    pointer-events: none;
}

.modalmask:target {
    opacity: 1;
    pointer-events: auto;
}

.modalbox {
    width: 600px;
    position: relative;
    padding: 5px 20px 13px 20px;
    background: #fff;
    border-radius: 3px;
    -webkit-transition: all 500ms ease-in;
    -moz-transition: all 500ms ease-in;
    transition: all 500ms ease-in;
}

.rotate {
    margin: 1% auto;
    -webkit-transform: scale(-5, -5);
    transform: scale(-5, -5);
}

.modalmask:target .rotate {
    transform: rotate(360deg) scale(1, 1);
    -webkit-transform: rotate(360deg) scale(1, 1);
}

.close {
    background: #606061;
    color: #FFFFFF;
    line-height: 25px;
    position: absolute;
    right: 1px;
    text-align: center;
    top: 1px;
    width: 24px;
    text-decoration: none;
    font-weight: bold;
    border-radius: 3px;
}

.close:hover {
    background: #FAAC58;
    color: #222;
}

.form-panel input, .form-panel textarea {
    margin-bottom: 15px;
}
</style>

---